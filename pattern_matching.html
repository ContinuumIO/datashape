

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Pattern Matching DataShapes &mdash; DataShape 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="DataShape 0.2 documentation" href="index.html" />
    <link rel="prev" title="DataShape Types" href="types.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="types.html" title="DataShape Types"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">DataShape 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pattern-matching-datashapes">
<h1>Pattern Matching DataShapes<a class="headerlink" href="#pattern-matching-datashapes" title="Permalink to this headline">¶</a></h1>
<p>DataShape includes type variables, as symbols beginning with a
capital letter. For example <cite>A * int32</cite> represents a one-dimensional
array of <cite>int32</cite>, where the size or type of the dimension is
unspecified. Similarly, <cite>3 * A</cite> represents a size 3 one-dimensional
array where the data type is unspecified.</p>
<p>The main usage of pattern matching in the DataShape system is for
specifying function signatures. To provide a little bit of motivation,
let&#8217;s examine what happens in NumPy ufuncs, and see how we can
represent their behaviors via DataShape types.</p>
<div class="section" id="numpy-ldexp-ufunc-example">
<h2>NumPy <cite>ldexp</cite> UFunc Example<a class="headerlink" href="#numpy-ldexp-ufunc-example" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;re going to use the <cite>ldexp</cite> ufunc, which is for the C/C++
function with overloads <cite>double ldexp(double x, int exp)</cite>
and <cite>float ldexp(float x, int exp)</cite>, computing <cite>x * 2^exp</cite>
by tweaking the exponent in the floating point format. (We&#8217;re
ignoring the long double for now.)</p>
<p>These C++ functions can be represented with the DataShape
function signatures:</p>
<div class="highlight-python"><pre>(float32, int32) -&gt; float32
(float64, int32) -&gt; float64</pre>
</div>
<p>As a NumPy ufunc, there is an behavior for arrays, where the
source arrays are &#8220;broadcasted&#8221; together, and the function is
computed elementwise.</p>
<p>In the simplest case, given two arrays which match, the result
is an array of the same size. When one array has size one in a
dimension, it gets repeated to match the size of the other dimension.
When one array has fewer dimensions, it gets repeated to fill
in the outer dimensions. The &#8220;broadcast&#8221; array shape is the result
of combining all these repetitions, and is the shape of the output.
Represented as DataShape function signatures, some examples are:</p>
<div class="highlight-python"><pre>(12 * float32, 12 * int32) -&gt; 12 * float32
(10 * float64, 1 * int32) -&gt; 10 * float64
(float32, 3 * 4 * int32) -&gt; 3 * 4 * float32
(3 * float64, 4 * 1 * int64) -&gt; 4 * 3 * float64</pre>
</div>
</div>
<div class="section" id="ellipsis-for-broadcasting">
<h2>Ellipsis for Broadcasting<a class="headerlink" href="#ellipsis-for-broadcasting" title="Permalink to this headline">¶</a></h2>
<p>To represent the general broadcasting behavior, DataShape provides
ellipsis type variables.:</p>
<div class="highlight-python"><pre>(A... * float32, A... * int32) -&gt; A... * float32
(A... * float64, A... * int64) -&gt; A... * float64</pre>
</div>
<div class="section" id="coercions-broadcasting-as-a-system-of-equations">
<h3>Coercions/Broadcasting as a System of Equations<a class="headerlink" href="#coercions-broadcasting-as-a-system-of-equations" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s say as input we get two arrays with datashapes
<cite>3 * 4 * float64</cite> and <cite>int32</cite>. We can express this as
two systems of coercion equations as follows (using ==&gt;
as a &#8220;coerces to&#8221; operator):</p>
<div class="highlight-python"><pre># float32 prototype
3 * 4 * float64 ==&gt; A... * float32
int32 ==&gt; A... * int32

# float64 prototype
3 * 4 * float64 ==&gt; A... * float64
int32 ==&gt; A... * int32</pre>
</div>
<p>To solve these equations, we evaluate the legality
of each coercion, and accumulate the set of values
the <cite>A...</cite> type variable must take.:</p>
<div class="highlight-python"><pre># float32 prototype
float64 ==&gt; float32 # ILLEGAL
3 * 4 * ==&gt; A... *  # &quot;3 * 4 *&quot; in A...
int32 ==&gt; int32     # LEGAL
* ==&gt; A...          # &quot;*&quot; in A...

# float64 prototype
float64 ==&gt; float64 # LEGAL
3 * 4 * ==&gt; A... *  # &quot;3 * 4 *&quot; in A...
int32 ==&gt; int32     # LEGAL
* ==&gt; A...          # &quot;*&quot; in A...</pre>
</div>
<p>The float32 prototype can be discarded because it requires an
illegal coercion. In the float64 prototype, we collect the set
of all <cite>A...</cite> values <cite>{&#8220;3 * 4 *&#8221;, &#8220;*&#8221;}</cite>, broadcast them together
to get <cite>&#8220;3 * 4 *&#8221;</cite>, and substitute this in the output. Doing
all the substitutions in the full prototype produces:</p>
<div class="highlight-python"><pre>(3 * 4 * float64, int32) -&gt; 3 * 4 * float64</pre>
</div>
<p>as the matched function prototype that results.</p>
</div>
</div>
<div class="section" id="disallowing-coercion">
<h2>Disallowing Coercion<a class="headerlink" href="#disallowing-coercion" title="Permalink to this headline">¶</a></h2>
<p>In the particular function we picked, ideally we don&#8217;t want to
allow implicit coercion of the type, because the nature of the
function is to &#8220;load the exponent&#8221; in particular formats of
floating point number. Saying <cite>ldexp(True, 3)</cite>, and having it
work is kind of weird.</p>
<p>One way to tackle this would be to add an <cite>exact</cite> type, both
as a dimension and a data type, which indicates that broadcasting
should be disallowed. For the discussion, in addition to <cite>ldexp</cite>,
lets introduce a vector magnitude function <cite>mag</cite>, where we want
to disallow scalar arrays to broadcast into it.:</p>
<div class="highlight-python"><pre># ldexp signatures
(A... * exact[float32], A... * int32) -&gt; A... * float32
(A... * exact[float64], A... * int64) -&gt; A... * float64

# mag signatures
(A... * exact[2] * float32) -&gt; A... * float32
(A... * exact[3] * float32) -&gt; A... * float32

# ufunc but disallowing broadcasting
(exact[A...] * int32, exact[A...] * int32) -&gt; A... * int32</pre>
</div>
<p>A possible syntactic sugar (which I&#8217;m not attached to, I think
this needs some exploration) for this is:</p>
<div class="highlight-python"><pre># ldexp signatures
(A... * float32=, A... * int32) -&gt; A... * float32
(A... * float64=, A... * int64) -&gt; A... * float64

# mag signatures
(A... * 2= * float32) -&gt; A... * float32
(A... * 3= * float32) -&gt; A... * float32

# ufunc but disallowing broadcasting
(A=.. * int32, A=.. * int32) -&gt; A... * int32</pre>
</div>
</div>
<div class="section" id="factoring-a-set-of-signatures">
<h2>Factoring a Set of Signatures<a class="headerlink" href="#factoring-a-set-of-signatures" title="Permalink to this headline">¶</a></h2>
<p>One of the main things the multiple dispatch in DataShape has
to do is match input arrays against a set of signatures very
efficiently. We need to be able to hide the abstraction we&#8217;re
creating, and provide performance competitive with, but ideally
superior to, what NumPy provides in its ufunc system.</p>
<p>Factoring the set of signatures into two or more stages which
are simpler to solve and can prune the possibilities more quickly
is one way to do this abstraction hiding. Let&#8217;s use the <cite>add</cite> function
for our example, with the following subset of signatures. We&#8217;ve
included the <cite>datetime</cite> signatures to dispel any notion that the
signatures will always match precisely.:</p>
<div class="highlight-python"><pre># add signatures
(A... * int32, A... * int32) -&gt; A... * int32
(A... * int64, A... * int64) -&gt; A... * int64
(A... * float32, A... * float32) -&gt; A... * float32
(A... * float64, A... * float64) -&gt; A... * float64
(A... * timedelta, A... * timedelta) -&gt; A... * timedelta
(A... * datetime, A... * timedelta) -&gt; A... * datetime
(A... * timedelta, A... * datetime) -&gt; A... * datetime</pre>
</div>
<p>Because the broadcasting of all these cases is identical, we
can transform this set of signatures into two stages as follows:</p>
<div class="highlight-python"><pre># broadcasting stage
(A... * X, A... * Y) -&gt; A... * Z

# data type stage matched against (X, Y)
(int32, int32) -&gt; int32
(int64, int64) -&gt; int64
(float32, float32) -&gt; float32
(float64, float64) -&gt; float64
(timedelta, timedelta) -&gt; timedelta
(datetime, timedelta) -&gt; datetime
(timedelta, datetime) -&gt; datetime</pre>
</div>
<p>Let&#8217;s work through this example to illustrate how it works.:</p>
<div class="highlight-python"><pre># Stage 1: Input arrays &quot;3 * 1 * int32&quot;, &quot;4 * float32&quot;
#    (A... * X, A... * Y) -&gt; A... * Z
int32 ==&gt; X       # &quot;int32&quot; in X
3 * 1 * ==&gt; A...  # &quot;3 * 1 *&quot; in A...
float32 ==&gt; Y     # &quot;float32&quot; in Y
4 * ==&gt; A...      # &quot;4 *&quot; in A...

# Solution: A... is &quot;3 * 4 *&quot;, X is &quot;int32&quot;, and Y is &quot;float32&quot;
# Stage 2: Input arrays &quot;int32&quot; and &quot;float32&quot;
#    (int32, int32) -&gt; int32
int32 ==&gt; int32     # LEGAL
float32 ==&gt; int32   # ILLEGAL
#    (float32, float32) -&gt; float32
int32 ==&gt; float32   # LEGAL
float32 ==&gt; float32 # LEGAL
# etc.

# Assume we picked (float32, float32) -&gt; float32
# so the variables are:
# X is &quot;float32&quot;
# Y is &quot;float32&quot;
# Z is &quot;float32&quot;
# giving the solution substituted into stage 1:
(3 * 1 * float32, 4 * float32) -&gt; 3 * 4 * float32</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Pattern Matching DataShapes</a><ul>
<li><a class="reference internal" href="#numpy-ldexp-ufunc-example">NumPy <cite>ldexp</cite> UFunc Example</a></li>
<li><a class="reference internal" href="#ellipsis-for-broadcasting">Ellipsis for Broadcasting</a><ul>
<li><a class="reference internal" href="#coercions-broadcasting-as-a-system-of-equations">Coercions/Broadcasting as a System of Equations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#disallowing-coercion">Disallowing Coercion</a></li>
<li><a class="reference internal" href="#factoring-a-set-of-signatures">Factoring a Set of Signatures</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="types.html"
                        title="previous chapter">DataShape Types</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/pattern_matching.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="types.html" title="DataShape Types"
             >previous</a> |</li>
        <li><a href="index.html">DataShape 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2014, Continuum Analytics.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>